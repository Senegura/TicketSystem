# Design Document

## Overview

This feature implements a Minimal API endpoint in ASP.NET Core for submitting new support tickets. The endpoint accepts multipart/form-data requests containing ticket information (full name, email, issue description) and an optional image file. The implementation follows the existing layered architecture pattern with API layer, business logic layer, and data access layer separation.

The endpoint will be added to Program.cs following the existing pattern established by the `/api/auth/login` endpoint. Image files will be stored in the `App_Data/uploads` directory with unique filenames, and the filename will be stored in the Ticket model's `ImageUrl` property.

## Architecture

### Layered Architecture

The implementation follows the existing three-tier architecture:

1. **API Layer (TicketSystem.Server)**: Minimal API endpoint in Program.cs that handles HTTP requests, validates input, manages file uploads, and returns responses
2. **Business Logic Layer (TicketSystem.BL)**: Service interface and implementation for ticket submission business rules (to be created)
3. **Data Access Layer (TicketSystem.DAL)**: Existing `ITicketDal` interface with `CreateAsync` method for persisting tickets

### Request Flow

```
Client Request (multipart/form-data)
    ↓
Minimal API Endpoint (/api/tickets)
    ↓
Input Validation (form fields + file)
    ↓
File Upload Handler (save to App_Data/uploads)
    ↓
ITicketService.CreateTicketAsync()
    ↓
ITicketDal.CreateAsync()
    ↓
Response (201 Created with ticket data)
```

## Components and Interfaces

### 1. Minimal API Endpoint

**Location**: `TicketSystem.Server/Program.cs`

**Route**: `POST /api/tickets`

**Request Format**: `multipart/form-data` with fields:
- `fullName` (string, required)
- `email` (string, required)
- `issueDescription` (string, required)
- `image` (IFormFile, optional)

**Responsibilities**:
- Accept multipart form data requests
- Validate required fields (full name ≥ 2 chars, email format, description ≥ 10 chars)
- Validate optional image file (size ≤ 5MB, type: JPEG/PNG/GIF)
- Handle file upload to App_Data/uploads directory
- Call ITicketService to create ticket
- Return appropriate HTTP status codes and responses

### 2. ITicketService Interface

**Location**: `TicketSystem.BL/ITicketService.cs` (new file)

```csharp
public interface ITicketService
{
    Task<Ticket> CreateTicketAsync(string fullName, string email, string description, string? imageFileName);
}
```

**Responsibilities**:
- Encapsulate ticket creation business logic
- Map input parameters to Ticket model
- Call ITicketDal.CreateAsync()
- Return created ticket

### 3. TicketService Implementation

**Location**: `TicketSystem.BL/TicketService.cs` (new file)

**Dependencies**:
- `ITicketDal` (injected via constructor)

**Responsibilities**:
- Create Ticket object with provided data
- Set default values (Status = New, timestamps)
- Delegate persistence to DAL layer

### 4. File Upload Handler

**Location**: Inline in the Minimal API endpoint

**Responsibilities**:
- Ensure App_Data/uploads directory exists
- Generate unique filename using GUID + original extension
- Validate file size (≤ 5MB)
- Validate file type (JPEG, PNG, GIF) using content type and extension
- Save file to disk using FileStream
- Return filename for storage in database

## Data Models

### Ticket Model (Existing)

**Location**: `TicketSystem.Models/Ticket.cs`

The existing Ticket model already contains all necessary properties:
- `Id` (Guid) - Generated by DAL
- `Name` (string) - Maps to fullName input
- `Email` (string) - Maps to email input
- `Description` (string) - Maps to issueDescription input
- `ImageUrl` (string) - Stores uploaded image filename
- `Status` (TicketStatus) - Set to default status (New)
- `CreatedAt` (DateTime) - Set by DAL
- `UpdatedAt` (DateTime) - Set by DAL
- `Summary` (string) - Empty for new tickets
- `Resolution` (string) - Empty for new tickets

### Request DTO

**Location**: `TicketSystem.Models/CreateTicketRequest.cs` (new file)

```csharp
public class CreateTicketRequest
{
    public string FullName { get; set; } = string.Empty;
    public string Email { get; set; } = string.Empty;
    public string IssueDescription { get; set; } = string.Empty;
}
```

Note: The image file will be handled separately as IFormFile in the endpoint, not as part of the DTO.

## Error Handling

### Validation Errors (HTTP 400)

Return structured error responses for:
- Missing or invalid full name (< 2 characters)
- Missing or invalid email format
- Missing or invalid issue description (< 10 characters)
- Invalid image file size (> 5MB)
- Invalid image file type (not JPEG/PNG/GIF)

**Response Format**:
```json
{
  "error": "Validation failed",
  "details": {
    "fullName": "Full name must be at least 2 characters",
    "email": "Invalid email format"
  }
}
```

### Server Errors (HTTP 500)

Handle exceptions during:
- File system operations (directory creation, file writing)
- Database operations (ticket creation)

**Response Format**:
```json
{
  "error": "An error occurred while processing your request"
}
```

### Success Response (HTTP 201)

Return created ticket with all fields:
```json
{
  "id": "3fa85f64-5717-4562-b3fc-2c963f66afa6",
  "name": "John Doe",
  "email": "john@example.com",
  "description": "Issue description here",
  "imageUrl": "abc123-def456.jpg",
  "status": 0,
  "createdAt": "2025-11-08T10:30:00Z",
  "updatedAt": "2025-11-08T10:30:00Z"
}
```

## Implementation Notes

### Service Registration

Add to `Program.cs` before `var app = builder.Build();`:

```csharp
builder.Services.AddSingleton<ITicketService, TicketService>();
```

### File Upload Configuration

- **Directory**: `App_Data/uploads` (relative to application root)
- **Filename Format**: `{Guid}.{extension}` (e.g., `3fa85f64-5717-4562-b3fc-2c963f66afa6.jpg`)
- **Allowed Extensions**: `.jpg`, `.jpeg`, `.png`, `.gif`
- **Allowed Content Types**: `image/jpeg`, `image/png`, `image/gif`
- **Max File Size**: 5,242,880 bytes (5MB)

### Email Validation

Use regular expression pattern:
```csharp
^[^@\s]+@[^@\s]+\.[^@\s]+$
```

This provides basic email format validation without being overly restrictive.

### CORS Configuration

The existing CORS policy `AllowFrontend` is already configured and will apply to the new endpoint automatically.

### Endpoint Placement

Add the new endpoint in `Program.cs` after the existing `/api/auth/login` endpoint and before `app.MapFallbackToFile("/index.html");`.
